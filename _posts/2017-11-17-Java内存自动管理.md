## Java虚拟机

### 虚拟机
- 定义：模拟某种计算机体系结构，执行特定指令集的软件
- 系统虚拟机、进程虚拟机

#### 系统虚拟机
- Virtual Box
- VMware

#### 进程虚拟机（提供特定指令集）
- JVM
- Adobe Flash Player
- FC模拟器

#### Java语言语言虚拟机
- 可以执行Java语言的高级语言虚拟机。Java语言虚拟机并不一定就可以称之为JVM，例如：Apache Harmony


## Java虚拟机
- 必须通过Java TCK（Technology COmpatibility Kit）的兼容性测试的Java语言虚拟机才能称之为“Java虚拟机”
- Java虚拟机并非一定要执行Java程序
- 业界三大商用JVM： Oracle HotSpot、 Oracle JRockitVm、 IBM J9 VM


#### Java虚拟机运行时数据区域
- 在《Java虚拟机规范》中定义了若干种程序运行期间会使用到的存储不同类型数据的区域。
- 有些区域是全局共享的，随着虚拟机启动而创建，随着虚拟机退出而销毁。有些区域是线程私有的，随着线程开始和结束而创建和销毁。
- 是所有Java虚拟机共同的内存区域概念模型。

#### 运行时数据区域的划分

- 程序计数器
- Java堆
- Java虚拟机栈
- 本地方法栈
- 方法区

## 程序计数器
- 一块较小的内存空间，他的作用可以看作是当前线程所执行的字节码的行号指示器。通俗的说可以将其看作一个指针，指向当前程序(字节码)运行的那一行代码。
- 如果线程正在执行的是一个java方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；如果正在执行的是Native，这个计数器值则为空。
- 此内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。

如图所示：![运行时数据区域的划分](../images/java_jvm_01.png)

## Java虚拟机和内存区域

### Java虚拟机栈
为了执行Java字节码服务。

#### 特征
- 线程私有，生命周期与线程相同，Java虚拟机栈描述的是Java方法执行时候描述的内存概念模型。每个方法在执行的时候，都会创建一个栈帧，用来创建这个方法的操作出栈，局部变量表，方法出口，动态链接等信息。每一个方法在调用和结束的过程，就对应了一个栈帧在虚拟机中入栈和出栈的过程。
- 虚拟机栈是一个后进先出（LIFO）栈。
- 存储栈帧，支撑Java方法的调用、执行和退出。
- Java虚拟机栈被设计为可以动态扩展，而动态扩展时无法申请到最够的内存，将会抛出OutOfMemoryError异常。
- 线程请求的栈深度大于Java虚拟机的允许的最大深度将会抛出StackOverflowError异常。


### 本地方法栈
为了执行 Native 方法服务。
#### 特征
- 线程私有。
- 后进先出栈。
- 作用是支撑Native方法的调用、执行和退出。
- 可能出现OutOfMemroyError异常和StackOverflowError异常。
- 有一些虚拟机将Java虚拟机栈和本地方法栈合并实现。

### 栈帧
#### 概念与特征
- Java虚拟机栈中存储的内容，它被设计用于存储数据和部分过程结果的数据结构，同时也被用来处理动态链接、方法返回值和异常分派。
- 一个完整的栈帧包括：局部变量表、操作数栈、动态链接信息、方法正常完成和异常完成信息。

在编译程序代码的时候，需要多大的局部变量表、需要多深的操作数栈就已确定。java编译器会把这些编译信息写入到class文件的code表中。一个栈帧需要分配多大的内存是不会受程序运行期间变量数据的影响，而仅仅取决于具体的java虚拟机。在一个线程里面方法调用的调用链可能会很长，很多方法可能都同时处于执行的状态。

对于执行引擎而言，在活动线程之中，只有位于java虚拟机栈栈顶的那个栈帧才是有效的，这个栈帧被称之为当前栈帧，与这个栈帧相关联的方法称之为当前方法。虚拟机引擎中所有执行的字节码指令都针对当前栈帧和当前方法操作。

### 局部变量表
#### 概念和特征

### 操作数栈
#### 概念和特征